---
import PageLayout from '../../layouts/PageLayout.astro';
import Section from '../common/Section.astro';
import Icon from '../Icon.astro';
import type { ContentMeta, ContentSection, Insight, Citation } from '../../lib/content-pipeline/config';

export interface Props {
  meta: ContentMeta;
  sections: ContentSection[];
  summary: string;
  insights: Insight[];
  citations: Citation[];
}

const { meta, sections, summary, insights, citations } = Astro.props;
---

<PageLayout title={meta.title} description={meta.description}>
  <Section background="white" padding="md">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-4">{meta.title}</h1>
      <p class="text-lg text-gray-700">{summary}</p>
      <div class="flex flex-wrap gap-2 mt-4 text-sm text-gray-500">
        <span class="px-3 py-1 bg-gray-100 rounded-full">Audience: {meta.audience}</span>
        <span class="px-3 py-1 bg-gray-100 rounded-full">Reading time: {meta.readingTime} min</span>
        {meta.keywords?.slice(0, 3).map(keyword => (
          <span class="px-3 py-1 bg-gray-100 rounded-full">#{keyword}</span>
        ))}
      </div>
    </div>
  </Section>

  {insights.length > 0 && (
    <Section background="cream" padding="md">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4">Executive Highlights</h2>
        <div class="space-y-4">
          {insights.map(insight => (
            <div class="bg-white rounded-xl border border-gray-200 p-4">
              <div class="flex items-start gap-3">
                <Icon name={insight.type === 'risk' ? 'warning' : insight.type === 'opportunity' ? 'target' : 'analytics'} class="w-6 h-6 text-blue-500" />
                <div>
                  <h3 class="text-lg font-semibold">
                    {insight.title}
                    {insight.referenceIds && insight.referenceIds.length > 0 && (
                      <span class="ml-1">
                        {insight.referenceIds.map(refId => (
                          <a href={`#${refId}`} class="text-blue-600 text-xs align-super hover:underline">[{refId.replace('cite_', '')}]</a>
                        ))}
                      </span>
                    )}
                  </h3>
                  <p class="text-gray-600">{insight.description}</p>
                  <p class="text-sm text-gray-500 mt-2">Confidence: {Math.round((insight.confidence ?? 0.6) * 100)}%</p>
                  {insight.snippet && (
                    <blockquote class="mt-2 text-sm italic text-gray-500 border-l-4 border-blue-200 pl-3">
                      {insight.snippet}
                    </blockquote>
                  )}
                  {insight.reviewNotes && insight.reviewNotes.length > 0 && (
                    <div class="mt-3 space-y-1 text-xs text-gray-500">
                      {insight.reviewNotes.map(note => (
                        <div>
                          <span class="uppercase tracking-wide mr-2">{note.reviewer}</span>
                          <span class={`font-semibold ${note.status === 'flagged' ? 'text-red-500' : note.status === 'unclear' ? 'text-amber-500' : 'text-green-600'}`}>{note.status}</span>
                          <span class="ml-2">{note.explanation}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </Section>
  )}

  {sections.map(section => (
    <Section background="white" padding="sm">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-3">
          {section.heading}
          {section.referenceIds && section.referenceIds.length > 0 && (
            <span class="ml-1">
              {section.referenceIds.map(refId => (
                <a href={`#${refId}`} class="text-blue-600 text-xs align-super hover:underline font-normal">[{refId.replace('cite_', '')}]</a>
              ))}
            </span>
          )}
        </h2>
        <p class="text-gray-700">{section.content}</p>
        {section.snippet && (
          <blockquote class="mt-2 text-sm italic text-gray-500 border-l-4 border-blue-200 pl-3">
            {section.snippet}
          </blockquote>
        )}
        {section.evidence && (
          <ul class="mt-4 space-y-2 text-sm text-gray-600">
            {section.evidence.map(e => (
              <li>
                <span class="font-medium">
                  {e.claim}
                  {e.citationIds && e.citationIds.length > 0 && (
                    <span class="ml-1">
                      {e.citationIds.map(refId => (
                        <a href={`#${refId}`} class="text-blue-600 text-xs align-super hover:underline">[{refId.replace('cite_', '')}]</a>
                      ))}
                    </span>
                  )}
                </span>
                <span class="ml-2 text-gray-500">Confidence: {Math.round((e.confidence ?? 0.6) * 100)}%</span>
              </li>
            ))}
          </ul>
        )}
        {section.reviewNotes && section.reviewNotes.length > 0 && (
          <div class="mt-3 space-y-1 text-xs text-gray-500">
            {section.reviewNotes.map(note => (
              <div>
                <span class="uppercase tracking-wide mr-2">{note.reviewer}</span>
                <span class={`font-semibold ${note.status === 'flagged' ? 'text-red-500' : note.status === 'unclear' ? 'text-amber-500' : 'text-green-600'}`}>{note.status}</span>
                <span class="ml-2">{note.explanation}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </Section>
  ))}

  {citations.length > 0 && (
    <Section background="cream" padding="sm">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-xl font-semibold mb-3">Source Library</h2>
        <div class="space-y-2 text-sm text-gray-600">
          {citations.map(citation => (
            <div id={citation.id}>
              <span class="font-mono text-gray-400">[{citation.id.replace('cite_', '')}]</span>
              <a href={citation.url} target="_blank" rel="noopener noreferrer" class="ml-2 text-blue-600 hover:text-blue-700">
                {citation.text}
              </a>
              <span class="ml-2 text-gray-400">({citation.source})</span>
            </div>
          ))}
        </div>
      </div>
    </Section>
  )}
</PageLayout>
