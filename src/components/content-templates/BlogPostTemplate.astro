---
import PageLayout from '../../layouts/PageLayout.astro';
import Section from '../common/Section.astro';
import type { ContentMeta, ContentSection, Insight, Citation } from '../../lib/content-pipeline/config';

export interface Props {
  meta: ContentMeta;
  sections: ContentSection[];
  summary: string;
  insights: Insight[];
  citations: Citation[];
}

const { meta, sections, summary, insights, citations } = Astro.props;
---

<PageLayout title={meta.title} description={meta.description}>
  <Section background="white" padding="lg">
    <article class="max-w-3xl mx-auto prose prose-lg">
      <h1>{meta.title}</h1>
      <p class="lead">{summary}</p>
      <div class="flex flex-wrap gap-2 text-sm text-gray-500">
        {meta.keywords?.slice(0, 6).map(keyword => (<span class="px-3 py-1 bg-gray-100 rounded-full">#{keyword}</span>))}
      </div>
    </article>
  </Section>

  {insights.length > 0 && (
    <Section background="cream" padding="md">
      <div class="max-w-3xl mx-auto">
        <h2 class="text-2xl font-bold mb-4">Key Takeaways</h2>
        <ul class="space-y-3">
          {insights.map(insight => (
          <li class="bg-white rounded-xl border border-gray-200 p-4">
            <h3 class="font-semibold text-lg">{insight.title}</h3>
            <p class="text-gray-600">{insight.description}</p>
            <p class="text-sm text-gray-500 mt-2">Confidence: {Math.round((insight.confidence ?? 0.6) * 100)}%</p>
            {insight.snippet && (
              <blockquote class="mt-2 text-sm italic text-gray-500 border-l-4 border-blue-200 pl-3">
                {insight.snippet}
              </blockquote>
            )}
            {insight.reviewNotes && insight.reviewNotes.length > 0 && (
              <div class="mt-3 space-y-1 text-xs text-gray-500">
                {insight.reviewNotes.map(note => (
                  <div>
                    <span class="uppercase tracking-wide mr-2">{note.reviewer}</span>
                    <span class={`font-semibold ${note.status === 'flagged' ? 'text-red-500' : note.status === 'unclear' ? 'text-amber-500' : 'text-green-600'}`}>{note.status}</span>
                    <span class="ml-2">{note.explanation}</span>
                  </div>
                ))}
              </div>
            )}
          </li>
        ))}
      </ul>
    </div>
  </Section>
  )}

  {sections.map(section => (
    <Section background="white" padding="md">
      <div class="max-w-3xl mx-auto prose prose-lg">
        <h2>{section.heading}</h2>
        <p>{section.content}</p>
        {section.snippet && (
          <blockquote>{section.snippet}</blockquote>
        )}
        {section.evidence && (
          <div class="not-prose mt-6 space-y-2">
            {section.evidence.map(e => (
              <div class="text-sm text-gray-600">
                <span class="font-medium">{e.claim}</span>
                <span class="ml-2 text-gray-500">Confidence: {Math.round((e.confidence ?? 0.6) * 100)}%</span>
              </div>
            ))}
          </div>
        )}
        {section.reviewNotes && section.reviewNotes.length > 0 && (
          <div class="not-prose mt-4 space-y-1 text-xs text-gray-500">
            {section.reviewNotes.map(note => (
              <div>
                <span class="uppercase tracking-wide mr-2">{note.reviewer}</span>
                <span class={`font-semibold ${note.status === 'flagged' ? 'text-red-500' : note.status === 'unclear' ? 'text-amber-500' : 'text-green-600'}`}>{note.status}</span>
                <span class="ml-2">{note.explanation}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </Section>
  ))}

  {citations.length > 0 && (
    <Section background="cream" padding="md">
      <div class="max-w-3xl mx-auto">
        <h2 class="text-xl font-bold mb-4">Sources</h2>
        <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
          {citations.map(citation => (
            <li>
              <a href={citation.url} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700">
                {citation.text}
              </a>
              <span class="ml-2 text-gray-400">({citation.source})</span>
            </li>
          ))}
        </ol>
      </div>
    </Section>
  )}
</PageLayout>
